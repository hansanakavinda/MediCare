@model IEnumerable<MediCare.Models.PAYMENT>

@{
    ViewData["Title"] = "Payment History";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-history me-2 text-primary"></i>
                    Payment History
                </h2>
                <a href="/Appointments/MyAppointments" class="btn btn-outline-primary">
                    <i class="fas fa-calendar me-1"></i>
                    View Appointments
                </a>
            </div>

            @if (Model != null && Model.Any())
            {
                <!-- Payment Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-primary text-white text-center">
                            <div class="card-body">
                                <i class="fas fa-receipt fa-2x mb-2"></i>
                                <h4>@Model.Count()</h4>
                                <small>Total Payments</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-success text-white text-center">
                            <div class="card-body">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                                <h4>@Model.Count(p => p.STATUS == "Completed")</h4>
                                <small>Successful</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-info text-white text-center">
                            <div class="card-body">
                                <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                                <h4>LKR @Model.Where(p => p.STATUS == "Completed").Sum(p => p.AMOUNT).ToString("N0")</h4>
                                <small>Total Paid</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-warning text-white text-center">
                            <div class="card-body">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <h4>@Model.Count(p => p.STATUS == "Pending")</h4>
                                <small>Pending</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment History Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Payment Transactions
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Transaction ID</th>
                                        <th>Appointment</th>
                                        <th>Doctor</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var payment in Model)
                                    {
                                        <tr>
                                            <td>
                                                <code class="text-primary">@payment.TXN_REF</code>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong>#@payment.APPOINTMENT_ID</strong>
                                                    <br>
                                                    <small class="text-muted">
                                                        @payment.APPOINTMENT?.SCHEDULED_AT.ToString("MMM dd, yyyy")
                                                        at @payment.APPOINTMENT?.SCHEDULED_AT.ToString("hh:mm tt")
                                                    </small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="doctor-avatar bg-primary text-white rounded-circle me-2">
                                                        @(payment.APPOINTMENT?.DOCTOR?.USER?.FULL_NAME?.FirstOrDefault() ?? 'D')
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold">Dr. @(payment.APPOINTMENT?.DOCTOR?.USER?.FULL_NAME ?? "N/A")</div>
                                                        <small class="text-muted">@(payment.APPOINTMENT?.DOCTOR?.SPECIALTY?.NAME ?? "General")</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="fw-bold text-success">LKR @payment.AMOUNT.ToString("N0")</span>
                                            </td>
                                            <td>
                                                @{
                                                    var (icon, color) = payment.METHOD?.ToLower() switch
                                                    {
                                                        "credit card" => ("fa-credit-card", "text-primary"),
                                                        "debit card" => ("fa-university", "text-success"),
                                                        "digital wallet" => ("fa-mobile-alt", "text-info"),
                                                        "bank transfer" => ("fa-building-columns", "text-warning"),
                                                        _ => ("fa-credit-card", "text-secondary")
                                                    };
                                                }
                                                <div class="d-flex align-items-center">
                                                    <i class="fas @icon @color me-2"></i>
                                                    <span>@payment.METHOD</span>
                                                </div>
                                            </td>
                                            <td>
                                                @{
                                                    var statusBadge = payment.STATUS?.ToLower() switch
                                                    {
                                                        "completed" => "bg-success",
                                                        "pending" => "bg-warning",
                                                        "failed" => "bg-danger",
                                                        "cancelled" => "bg-secondary",
                                                        _ => "bg-secondary"
                                                    };
                                                    var statusIcon = payment.STATUS?.ToLower() switch
                                                    {
                                                        "completed" => "fa-check",
                                                        "pending" => "fa-clock",
                                                        "failed" => "fa-times",
                                                        "cancelled" => "fa-ban",
                                                        _ => "fa-question"
                                                    };
                                                }
                                                <span class="badge @statusBadge">
                                                    <i class="fas @statusIcon me-1"></i>@payment.STATUS
                                                </span>
                                            </td>
                                            <td>
                                                @if (payment.PAID_AT.HasValue)
                                                {
                                                    <div>
                                                        <div>@payment.PAID_AT.Value.ToString("MMM dd, yyyy")</div>
                                                        <small class="text-muted">@payment.PAID_AT.Value.ToString("hh:mm tt")</small>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    @if (payment.STATUS == "Completed")
                                                    {
                                                        <a href="/Payments/PaymentSuccess/@payment.PAYMENT_ID" 
                                                           class="btn btn-sm btn-outline-primary" 
                                                           title="View Receipt">
                                                            <i class="fas fa-receipt"></i>
                                                        </a>
                                                    }
                                                    <button class="btn btn-sm btn-outline-info" 
                                                            onclick="copyTransactionId('@payment.TXN_REF')" 
                                                            title="Copy Transaction ID">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Filter and Search Options -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-filter me-2"></i>
                            Filter Options
                        </h6>
                    </div>
                    <div class="card-body">
                        <form method="get" class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select name="status" class="form-select">
                                    <option value="">All Status</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Failed">Failed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Payment Method</label>
                                <select name="method" class="form-select">
                                    <option value="">All Methods</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Debit Card">Debit Card</option>
                                    <option value="Digital Wallet">Digital Wallet</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">From Date</label>
                                <input type="date" name="fromDate" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">To Date</label>
                                <input type="date" name="toDate" class="form-control">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i> Apply Filters
                                </button>
                                <a href="/Payments/MyPayments" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i> Clear
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <!-- No Payments State -->
                <div class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-credit-card fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted">No Payment History</h4>
                        <p class="text-muted mb-4">You haven't made any payments yet. Start by booking an appointment.</p>
                        <a href="/Doctors" class="btn btn-primary btn-lg">
                            <i class="fas fa-search me-2"></i>
                            Find Doctors
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .doctor-avatar {
        width: 35px;
        height: 35px;
        font-size: 1rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        background-color: #f8f9fa;
    }

    .table td {
        vertical-align: middle;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    .empty-state {
        padding: 3rem 1rem;
    }

    code {
        font-size: 0.875em;
        background-color: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }

    .btn-group .btn {
        border-radius: 0.25rem !important;
        margin-right: 0.25rem;
    }

    .btn-group .btn:last-child {
        margin-right: 0;
    }

    .badge {
        font-size: 0.75em;
    }
</style>

<script>
    function copyTransactionId(txnId) {
        navigator.clipboard.writeText(txnId).then(function() {
            // Show success message
            const toast = document.createElement('div');
            toast.className = 'alert alert-success alert-dismissible fade show position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            toast.innerHTML = `
                <i class="fas fa-check me-2"></i>
                Transaction ID copied to clipboard!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }).catch(function() {
            alert('Failed to copy transaction ID');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Payment history page loaded');
    });
</script>